---
title: Caching each instruction separately with asLayers
sidebar: reference
permalink: reference/build/as_layers.html
---

Стадии `before_install`, `install`, `before_setup`, `setup` и `build_artifact` зависят от соответствующих инструкций в конфигурации. Любое изменение инструкций приводит к пересборке соответствующей стадии со всеми инструкциями. Таким образом, при тяжеловесных, требовательных ко времени, инструкциях разработка конфигурации может затянуться.

Добавим ко всему этому ситуацию, когда при выполнении команд сборка падает на одной из последних инструкций стадии. Помимо того, что сборку необходимо выполнять заново, нет возможности получить состояние среды до упавшей инструкции, проверить корректность выполнения предыдущих инструкций.

Для удобства разработки и отладки была введена директива `asLayers`, которая указывается для конкретного приложения или его артефакта в конфигурации, dappfile.yaml. При сборке инструкции кэшируются по отдельности, а пересборка осуществляется только при изменении их порядка.

При отсутствии директивы `asLayers` (или в случае asLayers: false) используется кэширование по умолчанию, т.е. один docker-образ на все инструкции стадии, а если указать asLayers: true, то включится новый режим кэширования — один docker-образ на одну команду для shell или один task для ansible.

Переключение между режимами сборки регулируется только директивой `asLayers` — остальные инструкции конфигурации остаются неизменными. После того, как сборочные инструкции отлажены, `asLayers` необходимо выключить.

Директива `asLayers` позволяет кэшировать инструкции по отдельности. При использовании опций интроспекции `--introspect-error` и `--introspect-before-error` пользователь может получить среду до или после выполнения проблемной инструкции.

Важно не пользоваться этой инструкцией при штатной сборке образов: данный режим порождает избыточное количество docker-образов и не рассчитан на инкрементальную сборку (т.к. увеличивается время ожидания и размер сборочного кэша).
